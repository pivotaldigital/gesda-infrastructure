{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "subscriptionId": {
            "type": "string",
            "defaultValue": "[subscription().id]",
            "metadata": {
                "description": "Specify a subscription Id for the resources."
            }
        },
        "name": {
            "type": "string",
            "minLength": 3,
            "maxLength": 11,
            "metadata": {
                "description": "Specify a project name that is used to generate resource names."
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Specify a location for the resources."
            }
        },
        "hostingPlanName": {
            "type": "string",
            "defaultValue": "ASP-gesdauk-a3be"
        },
        "serverFarmResourceGroup": {
            "type": "string",
            "defaultValue": "gesda-uk"
        },
        "ftpsState": {
            "type": "string",
            "defaultValue": "FtpsOnly"
        },
        "autoGeneratedDomainNameLabelScope": {
            "type": "string",
            "defaultValue": "TenantReuse"
        },
        "sku": {
            "type": "string",
            "defaultValue": "Premium0V3"
        },
        "skuCode": {
            "type": "string",
            "defaultValue": "P0V3"
        },
        "workerSize": {
            "type": "string",
            "defaultValue": "18"
        },
        "workerSizeId": {
            "type": "string",
            "defaultValue": "18"
        },
        "numberOfWorkers": {
            "type": "string",
            "defaultValue": "1"
        },
        "kind": {
            "type": "string",
            "defaultValue": "linux"
        },
        "reserved": {
            "type": "bool",
            "defaultValue": true
        },
        "alwaysOn": {
            "type": "bool",
            "defaultValue": true
        },
        "linuxFxVersion": {
            "type": "string",
            "defaultValue": "DOCKER|mcr.microsoft.com/appsvc/wordpress-debian-php:8.3"
        },
        "dockerRegistryUrl": {
            "type": "string",
            "defaultValue": "https://mcr.microsoft.com"
        },
        "storageSizeGB": {
            "type": "int",
            "defaultValue": 128
        },
        "storageIops": {
            "type": "int",
            "defaultValue": 700
        },
        "storageAutoGrow": {
            "type": "string",
            "defaultValue": "Enabled"
        },
        "storageAutoIoScaling": {
            "type": "string",
            "defaultValue": "Enabled"
        },
        "backupRetentionDays": {
            "type": "int",
            "defaultValue": 7
        },
        "geoRedundantBackup": {
            "type": "string",
            "defaultValue": "Disabled"
        },
        "charset": {
            "type": "string",
            "defaultValue": "utf8"
        },
        "collation": {
            "type": "string",
            "defaultValue": "utf8_general_ci"
        },
        "vmName": {
            "type": "string",
            "defaultValue": "Standard_B2s"
        },
        "serverEdition": {
            "type": "string",
            "defaultValue": "Burstable"
        },
        "vCores": {
            "type": "int",
            "defaultValue": 2
        },
        "serverName": {
            "type": "string"
        },
        "serverUsername": {
            "type": "string"
        },
        "serverPassword": {
            "type": "securestring"
        },
        "databaseName": {
            "type": "string"
        },
        "publicNetworkAccess": {
            "type": "string",
            "defaultValue": "Disabled"
        },
        "stagingDatabaseName": {
            "type": "string"
        },
        "wordpressAdminEmail": {
            "type": "string"
        },
        "wordpressUsername": {
            "type": "string"
        },
        "wordpressPassword": {
            "type": "securestring"
        },
        "wpLocaleCode": {
            "type": "string"
        },
        "cdnProfileName": {
            "type": "string",
            "defaultValue": "gesda-bc8f815183-cdnprofile"
        },
        "cdnEndpointName": {
            "type": "string",
            "defaultValue": "gesda-bc8f815183-endpoint"
        },
        "cdnType": {
            "type": "string",
            "defaultValue": "Standard_Microsoft"
        },
        "stagingCdnEndpointName": {
            "type": "string",
            "defaultValue": "gesda-bc8f815183-endpoint-staging"
        },
        "storageAccountName": {
            "type": "string",
            "defaultValue": "gesdabc8f815183"
        },
        "storageAccountType": {
            "type": "string",
            "defaultValue": "Standard_RAGRS"
        },
        "storageAccountKind": {
            "type": "string",
            "defaultValue": "StorageV2"
        },
        "storageAccountResourceGroup": {
            "type": "string",
            "defaultValue": "gesda-uk"
        },
        "accessTier": {
            "type": "string",
            "defaultValue": "Hot"
        },
        "minimumTlsVersion": {
            "type": "string",
            "defaultValue": "TLS1_2"
        },
        "supportsHttpsTrafficOnly": {
            "type": "bool",
            "defaultValue": true
        },
        "allowBlobPublicAccess": {
            "type": "bool",
            "defaultValue": true
        },
        "allowSharedKeyAccess": {
            "type": "bool",
            "defaultValue": true
        },
        "allowCrossTenantReplication": {
            "type": "bool",
            "defaultValue": true
        },
        "networkAclsBypass": {
            "type": "string",
            "defaultValue": "AzureServices"
        },
        "networkAclsDefaultAction": {
            "type": "string",
            "defaultValue": "Allow"
        },
        "keySource": {
            "type": "string",
            "defaultValue": "Microsoft.Storage"
        },
        "encryptionEnabled": {
            "type": "bool",
            "defaultValue": false
        },
        "infrastructureEncryptionEnabled": {
            "type": "bool",
            "defaultValue": false
        },
        "blobContainerName": {
            "type": "string",
            "defaultValue": "blobgesdabc8f815183"
        },
        "blobPublicAccessLevel": {
            "type": "string",
            "defaultValue": "blob"
        },
        "stagingBlobContainerName": {
            "type": "string",
            "defaultValue": "blobgesdabc8f815183staging"
        },
        "vnetName": {
            "type": "string",
            "defaultValue": "gesda-bc8f815183-vnet"
        },
        "subnetForApp": {
            "type": "string",
            "defaultValue": "gesda-bc8f815183-appsubnet"
        },
        "subnetForDb": {
            "type": "string",
            "defaultValue": "gesda-bc8f815183-dbsubnet"
        },
        "privateDnsZoneNameForDb": {
            "type": "string",
            "defaultValue": "gesda-bc8f815183-privatelink.mysql.database.azure.com"
        },
        "emailDataLocation": {
            "type": "string",
            "defaultValue": "switzerland"
        },
        "emailCommServiceName": {
            "type": "string",
            "defaultValue": "gesda-bc8f815183-emailacsendpoint"
        },
        "commServiceName": {
            "type": "string",
            "defaultValue": "gesda-bc8f815183-acsendpoint"
        },
        "managedIdentityName": {
            "type": "string",
            "defaultValue": "gesda-bc8f815183-wpidentity"
        },
        "registryName": {
            "type": "string"
        },
        "registryLocation": {
            "type": "string"
        },
        "zoneRedundancy": {
            "type": "string"
        },
        "registrySku": {
            "type": "string"
        },
        "registryPublicNetworkAccess": {
            "type": "string"
        },
        "kvName": {
            "type": "string"
        },
        "kvSku": {
            "type": "string"
        },
        "kvAccessPolicies": {
            "type": "array"
        },
        "kvEnabledForDeployment": {
            "type": "bool"
        },
        "kvEnabledForTemplateDeployment": {
            "type": "bool"
        },
        "kvEnabledForDiskEncryption": {
            "type": "bool"
        },
        "kvEnableRbacAuthorization": {
            "type": "bool"
        },
        "kvPublicNetworkAccess": {
            "type": "string"
        },
        "kvEnableSoftDelete": {
            "type": "bool"
        },
        "kvSoftDeleteRetentionInDays": {
            "type": "int"
        },
        "kvNetworkAcls": {
            "type": "object"
        },
        "kvSecretName": {
            "type": "string"
        },
        "kvSecretValue": {
            "type": "securestring"
        },
        "certificateName": {
            "type": "string",
            "metadata": {
                "description": "User friendly certificate resource name"
            }
        }
    },
    "variables": {
        "appServicesApiVersion": "2021-03-01",
        "vnetDeploymentApiVersion": "2020-07-01",
        "vnetAddress": "10.0.0.0/23",
        "registryApiVersion": "2022-02-01-preview",
        "keyVaultApiVersion": "2021-11-01-preview",
        "tenantId": "[subscription().tenantId]"
    },
    "resources": [
        {
            "apiVersion": "[variables('registryApiVersion')]",
            "name": "[parameters('registryName')]",
            "type": "Microsoft.ContainerRegistry/registries",
            "location": "[parameters('registryLocation')]",
            "sku": {
                "name": "[parameters('registrySku')]"
            },
            "properties": {
                "publicNetworkAccess": "[parameters('registryPublicNetworkAccess')]",
                "zoneRedundancy": "[parameters('zoneRedundancy')]"
            }
        },
        {
            "apiVersion": "[variables('keyVaultApiVersion')]",
            "type": "Microsoft.KeyVault/vaults",
            "name": "[parameters('kvName')]",
            "location": "[parameters('location')]",
            "properties": {
                "enabledForDeployment": "[parameters('kvEnabledForDeployment')]",
                "enabledForTemplateDeployment": "[parameters('kvEnabledForTemplateDeployment')]",
                "enabledForDiskEncryption": "[parameters('kvEnabledForDiskEncryption')]",
                "enableRbacAuthorization": "[parameters('kvEnableRbacAuthorization')]",
                "accessPolicies": [
                    {
                        "tenantId": "[subscription().tenantId]",
                        "objectId": "182dc11c-5d0e-4fcc-8dd9-a7accff0d248",
                        "permissions": {
                            "secrets": [
                                "get",
                                "list",
                                "set"
                            ],
                            "certificates": [
                                "get",
                                "list",
                                "create"
                            ]
                        }
                    },
                    {
                        "tenantId": "[subscription().tenantId]",
                        "objectId": "bb9a7bd2-36da-4efa-9745-8a2420410f8f",
                        "permissions": {
                            "secrets": [
                                "get",
                                "list",
                                "set"
                            ],
                            "certificates": [
                                "get",
                                "list",
                                "create"
                            ]
                        }
                    }
                ],
                "tenantId": "[variables('tenantId')]",
                "sku": {
                    "name": "[parameters('kvSku')]",
                    "family": "A"
                },
                "publicNetworkAccess": "[parameters('kvPublicNetworkAccess')]",
                "enableSoftDelete": "[parameters('kvEnableSoftDelete')]",
                "softDeleteRetentionInDays": "[parameters('kvSoftDeleteRetentionInDays')]",
                "networkAcls": "[parameters('kvNetworkAcls')]"
            },
            "tags": {},
            "dependsOn": []
        },
        {
            "apiVersion": "[variables('keyVaultApiVersion')]",
            "type": "Microsoft.KeyVault/vaults/secrets",
            "name": "[format('{0}/{1}', parameters('kvName'), parameters('kvSecretName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
            ],
            "properties": {
                "value": "[parameters('kvSecretValue')]"
            }
        },
        {
            "type": "Microsoft.Web/certificates",
            "name": "[parameters('certificateName')]",
            "apiVersion": "2021-02-01",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults/secrets', parameters('kvName'), parameters('kvSecretName'))]",
                "[resourceId('Microsoft.Web/serverfarms', parameters('hostingPlanName'))]"
            ],
            "properties": {
                "canonicalName": "gesda.pivotal.digital",
                "domainValidationMethod": "http-token",
                "keyVaultId": "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]",
                "keyVaultSecretName": "[resourceId('Microsoft.KeyVault/vaults/secrets', parameters('kvName'), parameters('kvSecretName'))]",
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('hostingPlanName'))]"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "[variables('vnetDeploymentApiVersion')]",
            "location": "[parameters('location')]",
            "name": "[parameters('vnetName')]",
            "tags": {
                "AppProfile": "Wordpress",
                "WordPressDeploymentID": "gesda-bc8f815181"
            },
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[variables('vnetAddress')]"
                    ]
                },
                "subnets": []
            },
            "dependsOn": []
        },
        {
            "condition": true,
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2021-03-01",
            "name": "[format('{0}/{1}', parameters('vnetName'), parameters('subnetForApp'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/', parameters('vnetName'))]"
            ],
            "properties": {
                "addressPrefix": "10.0.0.0/25",
                "delegations": [
                    {
                        "name": "dlg-appService",
                        "properties": {
                            "serviceName": "Microsoft.Web/serverFarms"
                        }
                    }
                ]
            }
        },
        {
            "condition": true,
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2021-03-01",
            "name": "[format('{0}/{1}',parameters('vnetName'), parameters('subnetForDb'))]",
            "properties": {
                "addressPrefix": "10.0.1.0/25",
                "delegations": [
                    {
                        "name": "dlg-appService",
                        "properties": {
                            "serviceName": "Microsoft.DBforMySQL/flexibleServers"
                        }
                    }
                ]
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetForApp'))]"
            ]
        },
        {
            "apiVersion": "[variables('appServicesApiVersion')]",
            "name": "[parameters('hostingPlanName')]",
            "type": "Microsoft.Web/serverfarms",
            "location": "[parameters('location')]",
            "kind": "[parameters('kind')]",
            "tags": {
                "AppProfile": "Wordpress",
                "WordPressDeploymentID": "gesda-bc8f815181"
            },
            "properties": {
                "name": "[parameters('hostingPlanName')]",
                "workerSize": "[parameters('workerSize')]",
                "workerSizeId": "[parameters('workerSizeId')]",
                "numberOfWorkers": "[parameters('numberOfWorkers')]",
                "reserved": "[parameters('reserved')]",
                "zoneRedundant": false
            },
            "sku": {
                "Tier": "[parameters('sku')]",
                "Name": "[parameters('skuCode')]"
            }
        }
    ],
    "outputs": {
        "tenantResult": {
            "type": "string",
            "value": "[variables('tenantId')]"
        }
    }
}